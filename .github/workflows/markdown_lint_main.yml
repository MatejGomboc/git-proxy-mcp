name: Markdown Lint - Main Branch

permissions:
    contents: read
    actions: write

on:
    push:
        branches: [main]
        paths:
            - "**/*.md"
            - ".markdownlint.json"
            - ".markdownlint-cli2.jsonc"

    workflow_dispatch:

jobs:
    lint-markdown:
        name: Lint Markdown
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Setup Node.js
              id: setup-node
              uses: actions/setup-node@v4
              with:
                  node-version: "lts/*"

            - name: Get markdownlint-cli2 latest version
              id: mdlint-version
              run: echo "version=$(npm view markdownlint-cli2 version)" >> "$GITHUB_OUTPUT"

            - name: Restore npm cache
              id: cache-restore
              uses: actions/cache/restore@v4
              with:
                  path: ~/.npm
                  key: npm-markdownlint-${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-mdlint-${{ steps.mdlint-version.outputs.version }}

            - name: Install markdownlint-cli2
              run: npm install -g markdownlint-cli2

            - name: Run markdownlint
              run: markdownlint-cli2 "**/*.md"

            # Save cache only on cache miss (Node or markdownlint-cli2 version changed)
            - name: Save npm cache
              if: steps.cache-restore.outputs.cache-hit != 'true'
              uses: actions/cache/save@v4
              with:
                  path: ~/.npm
                  key: npm-markdownlint-${{ runner.os }}-node-${{ steps.setup-node.outputs.node-version }}-mdlint-${{ steps.mdlint-version.outputs.version }}
