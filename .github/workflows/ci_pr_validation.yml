name: CI - PR Validation

permissions:
    contents: read

on:
    pull_request:
        branches: ["**"] # Run PR validation on any branch.

    workflow_dispatch: # Manual trigger option.

jobs:
    verify_pr:
        timeout-minutes: 30

        strategy:
            fail-fast: false # Don't cancel other jobs if one fails.

            max-parallel: 20 # Use maximum possible parallelisation.

            matrix:
                arch: [m0, m0plus, m1, m3]

        runs-on: ubuntu-latest

        container:
            image: ghcr.io/matejgomboc/armcortexm-cpplib-devenv:latest

        steps:
            - name: Checkout Github repository
              uses: actions/checkout@v6

            - name: Run CMake Workflow
              run: cmake --workflow --preset=${{ matrix.arch }}

    pr_verification_summary:
        needs: verify_pr

        runs-on: ubuntu-latest

        if: always() # Run even if some matrix jobs failed.

        steps:
            - name: Check if all jobs succeeded
              run: |
                if [[ "${{ needs.verify_pr.result }}" != "success" ]]; then
                  echo "One or more jobs failed"
                  exit 1
                fi
                echo "All jobs completed successfully"
