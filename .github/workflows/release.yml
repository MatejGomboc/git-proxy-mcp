name: Release

permissions:
    contents: write

on:
    push:
        tags:
            - "v[0-9]+.[0-9]+.[0-9]+"
            - "v[0-9]+.[0-9]+.[0-9]+-*"

    workflow_dispatch:
        inputs:
            tag:
                description: "Tag to release (e.g., v0.1.0)"
                required: true
                type: string

env:
    CARGO_TERM_COLOR: always
    RUSTFLAGS: "-Dwarnings"

jobs:
    validate:
        name: Validate Release
        runs-on: ubuntu-latest

        outputs:
            version: ${{ steps.version.outputs.version }}
            tag: ${{ steps.version.outputs.tag }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Determine version
              id: version
              shell: bash
              run: |
                  if [[ -n "${{ inputs.tag }}" ]]; then
                      TAG="${{ inputs.tag }}"
                  else
                      TAG="${GITHUB_REF#refs/tags/}"
                  fi

                  # Validate tag format
                  if [[ ! "$TAG" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-.*)?$ ]]; then
                      echo "Error: Invalid tag format: $TAG"
                      echo "Expected format: v0.0.0 or v0.0.0-suffix"
                      exit 1
                  fi

                  VERSION="${TAG#v}"
                  echo "tag=$TAG" >> "$GITHUB_OUTPUT"
                  echo "version=$VERSION" >> "$GITHUB_OUTPUT"
                  echo "Release version: $VERSION (tag: $TAG)"

            - name: Verify Cargo.toml version matches tag
              shell: bash
              run: |
                  CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
                  TAG_VERSION="${{ steps.version.outputs.version }}"

                  # For pre-release tags like v0.1.0-rc1, compare base version
                  BASE_TAG_VERSION="${TAG_VERSION%%-*}"

                  if [[ "$CARGO_VERSION" != "$BASE_TAG_VERSION" ]]; then
                      echo "Error: Version mismatch!"
                      echo "  Cargo.toml: $CARGO_VERSION"
                      echo "  Tag:        $BASE_TAG_VERSION"
                      echo ""
                      echo "Update Cargo.toml version before tagging."
                      exit 1
                  fi

                  echo "Version verified: $CARGO_VERSION"

    build:
        name: Build (${{ matrix.target }})
        needs: validate
        timeout-minutes: 30

        strategy:
            fail-fast: false
            matrix:
                include:
                    - os: ubuntu-latest
                      target: x86_64-unknown-linux-gnu
                      artifact: git-proxy-mcp-linux-x86_64
                      binary: git-proxy-mcp

                    - os: macos-latest
                      target: x86_64-apple-darwin
                      artifact: git-proxy-mcp-macos-x86_64
                      binary: git-proxy-mcp

                    - os: macos-latest
                      target: aarch64-apple-darwin
                      artifact: git-proxy-mcp-macos-aarch64
                      binary: git-proxy-mcp

                    - os: windows-latest
                      target: x86_64-pc-windows-msvc
                      artifact: git-proxy-mcp-windows-x86_64
                      binary: git-proxy-mcp.exe

        runs-on: ${{ matrix.os }}

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Install Rust toolchain
              uses: dtolnay/rust-toolchain@stable
              with:
                  targets: ${{ matrix.target }}

            - name: Get Rust version
              id: rust-version
              shell: bash
              run: |
                  if command -v sha256sum &> /dev/null; then
                      HASH_CMD="sha256sum"
                  else
                      HASH_CMD="shasum -a 256"
                  fi
                  echo "version=$(rustc --version | $HASH_CMD | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

            - name: Restore Rust cache
              uses: actions/cache/restore@v5
              with:
                  path: |
                      ~/.cargo/bin/
                      ~/.cargo/registry/index/
                      ~/.cargo/registry/cache/
                      ~/.cargo/git/db/
                      target/
                  key: rust-${{ runner.os }}-${{ steps.rust-version.outputs.version }}-${{ hashFiles('**/Cargo.lock') }}
                  restore-keys: |
                      rust-${{ runner.os }}-${{ steps.rust-version.outputs.version }}-

            - name: Build release binary
              shell: bash
              run: cargo build --release --target ${{ matrix.target }} --verbose

            - name: Run tests
              shell: bash
              run: cargo test --release --target ${{ matrix.target }} --verbose

            - name: Prepare artifact (Unix)
              if: runner.os != 'Windows'
              shell: bash
              run: |
                  mkdir -p dist
                  cp target/${{ matrix.target }}/release/${{ matrix.binary }} dist/
                  cp README.md LICENCE CHANGELOG.md dist/
                  cp config/example-config.json dist/
                  cd dist
                  tar -czvf ../${{ matrix.artifact }}.tar.gz *

            - name: Prepare artifact (Windows)
              if: runner.os == 'Windows'
              shell: bash
              run: |
                  mkdir -p dist
                  cp target/${{ matrix.target }}/release/${{ matrix.binary }} dist/
                  cp README.md LICENCE CHANGELOG.md dist/
                  cp config/example-config.json dist/
                  cd dist
                  7z a -tzip ../${{ matrix.artifact }}.zip *

            - name: Upload artifact (Unix)
              if: runner.os != 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.tar.gz
                  retention-days: 7

            - name: Upload artifact (Windows)
              if: runner.os == 'Windows'
              uses: actions/upload-artifact@v4
              with:
                  name: ${{ matrix.artifact }}
                  path: ${{ matrix.artifact }}.zip
                  retention-days: 7

    release:
        name: Create Release
        needs: [validate, build]
        runs-on: ubuntu-latest

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: artifacts

            - name: List artifacts
              run: find artifacts -type f

            - name: Generate checksums
              shell: bash
              run: |
                  cd artifacts
                  find . -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} . \;
                  sha256sum *.tar.gz *.zip > SHA256SUMS.txt
                  cat SHA256SUMS.txt

            - name: Extract release notes from CHANGELOG
              id: release-notes
              shell: bash
              run: |
                  VERSION="${{ needs.validate.outputs.version }}"

                  # Try to extract notes for this version from CHANGELOG.md
                  # Look for ## [version] or ## version header
                  if grep -q "## \[${VERSION}\]" CHANGELOG.md || grep -q "## ${VERSION}" CHANGELOG.md; then
                      # Extract content between this version header and the next
                      sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' > release_notes.md || \
                      sed -n "/## ${VERSION}/,/## /p" CHANGELOG.md | sed '$d' > release_notes.md

                      if [[ -s release_notes.md ]]; then
                          echo "Found release notes in CHANGELOG.md"
                      else
                          echo "No specific release notes found, using default"
                          echo "Release ${VERSION}" > release_notes.md
                      fi
                  else
                      echo "No CHANGELOG entry for ${VERSION}, using default"
                      echo "Release ${VERSION}" > release_notes.md
                  fi

                  echo ""
                  echo "--- Release Notes ---"
                  cat release_notes.md

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.validate.outputs.tag }}
                  name: ${{ needs.validate.outputs.tag }}
                  body_path: release_notes.md
                  draft: false
                  prerelease: ${{ contains(needs.validate.outputs.version, '-') }}
                  files: |
                      artifacts/*.tar.gz
                      artifacts/*.zip
                      artifacts/SHA256SUMS.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
